<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Luminar School</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Add CKEditor for rich text editing -->
    <script src="https://cdn.ckeditor.com/4.16.2/standard/ckeditor.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2><a href="index.html" style="color: white; text-decoration: none;">Luminar School Admin</a></h2>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="logout()">Logout</a>
                </li>
            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Admin Container -->
    <div class="admin-container">
        <div class="admin-header">
            <h1>Admin Dashboard</h1>
            <p>Manage users, content, and platform settings</p>
        </div>

        <!-- Admin Navigation -->
        <div class="admin-nav">
            <button class="admin-nav-btn active" onclick="showSection(event, 'dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="admin-nav-btn" onclick="showSection(event, 'users')">
                <i class="fas fa-users"></i> Users
            </button>
            <button class="admin-nav-btn" onclick="showSection(event, 'payments')">
                <i class="fas fa-credit-card"></i> Payments
            </button>
            <button class="admin-nav-btn" onclick="showSection(event, 'content')">
                <i class="fas fa-book"></i> Content
            </button>
            <button class="admin-nav-btn" onclick="showSection(event, 'reports')">
                <i class="fas fa-chart-bar"></i> Reports
            </button>
            <button class="admin-nav-btn" onclick="showSection(event, 'settings')">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>

        <!-- Admin Content -->
        <div class="admin-content">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="admin-section">
                <h2>Platform Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalUsers">0</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="activeUsers">0</h3>
                        <p>Active Users</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="pendingPayments">0</h3>
                        <p>Pending Payments</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalRevenue">0 ETB</h3>
                        <p>Total Revenue</p>
                    </div>
                </div>

                <div class="grid-2-col" style="margin-top: 2rem;">
                    <div class="card">
                        <h3>Recent Users</h3>
                        <div id="recentUsers">
                            <!-- Recent users will be loaded here -->
                        </div>
                    </div>
                    <div class="card">
                        <h3>Recent Payments</h3>
                        <div id="recentPayments">
                            <!-- Recent payments will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="usersSection" class="admin-section" style="display: none;">
                <h2>User Management</h2>
                <div style="margin-bottom: 2rem;">
                    <button class="btn btn-primary" onclick="refreshUsers()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="table-responsive-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>School</th>
                                <th>Status</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                    <div class="pagination" id="usersPagination">
                        <!-- Pagination controls will be added here -->
                    </div>
                </div>
            </div>

            <!-- Payments Section -->
            <div id="paymentsSection" class="admin-section" style="display: none;">
                <h2>Payment Management</h2>
                <div style="margin-bottom: 2rem;">
                    <button class="btn btn-primary" onclick="refreshPayments()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="table-responsive-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Account Name</th>
                                <th>Plan</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Account Number</th>
                                <th>Transaction ID</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTable">
                            <!-- Payments will be loaded here -->
                        </tbody>
                    </table>
                    <div class="pagination" id="paymentsPagination">
                        <!-- Pagination controls will be added here -->
                    </div>
                </div>
            </div>

            <!-- Content Section -->
            <div id="contentSection" class="admin-section" style="display: none;">
                <h2>Content Management</h2>
                <div class="grid-3-col">
                    <div class="card">
                        <h3>Upload Course Material</h3>
                        <form id="contentUploadForm" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="subject">Subject</label>
                                <select id="subject" name="subject" required></select>
                            </div>
                            <div class="form-group" id="gradeGroup">
                                <label for="grade">Grade</label>
                                <select id="grade" name="grade" required>
                                    <option value="">Select Grade</option>
                                    <option value="9">Grade 9</option>
                                    <option value="10">Grade 10</option>
                                    <option value="11">Grade 11</option>
                                    <option value="12">Grade 12</option>
                                </select>
                            </div>
                            <div class="form-group" id="unitGroup">
                                <label for="unit">Unit</label>
                                <input type="number" id="unit" name="unit" min="1" max="20" required>
                            </div>
                            <div class="form-group">
                                <label for="title">Title</label>
                                <input type="text" id="title" name="title" required>
                            </div>
                            <div class="form-group">
                                <label for="mediaFile">Media File (Video, PDF, etc. - Optional)</label>
                                <input type="file" id="mediaFile" name="mediaFile" accept="video/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="file-input">
                            </div>
                            <div class="form-group">
                                <label for="content">Content</label>
                                <textarea id="content" name="content" rows="10" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload"></i> Upload Content
                            </button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>Add Quiz Questions</h3>
                        <form id="quizUploadForm">
                            <div class="form-group">
                                <label for="quizSubject">Subject</label>
                                <select id="quizSubject" name="quizSubject" required></select>
                            </div>
                            <div class="form-group">
                                <label for="quizGrade" id="quizGradeLabel">Grade</label>
                                <select id="quizGrade" name="quizGrade" required>
                                    <option value="">Select Grade</option>
                                    <option value="9">Grade 9</option>
                                    <option value="10">Grade 10</option>
                                    <option value="11">Grade 11</option>
                                    <option value="12">Grade 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="quizUnit" id="quizUnitLabel">Unit</label>
                                <input type="number" id="quizUnit" name="quizUnit" min="1" max="20" required>
                            </div>
                            <div class="form-group">
                                <label for="question">Question</label>
                                <textarea id="question" name="question" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="options">Options (one per line)</label>
                                <textarea id="options" name="options" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="correctAnswer">Correct Answer (0-3)</label>
                                <input type="number" id="correctAnswer" name="correctAnswer" min="0" max="3" required>
                            </div>
                            <div class="form-group">
                                <label for="explanation">Explanation</label>
                                <textarea id="explanation" name="explanation" rows="2" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Question
                            </button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>Add Final Exam Question</h3>
                        <form id="finalExamUploadForm">
                            <div class="form-group">
                                <label for="finalExamStream">Stream</label>
                                <select id="finalExamStream" name="stream" required>
                                    <option value="">Select Stream</option>
                                    <option value="natural">Natural Sciences</option>
                                    <option value="social">Social Sciences</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="finalExamQuestion">Question</label>
                                <textarea id="finalExamQuestion" name="question" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="finalExamOptions">Options (one per line)</label>
                                <textarea id="finalExamOptions" name="options" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="finalExamCorrectAnswer">Correct Answer (0-3)</label>
                                <input type="number" id="finalExamCorrectAnswer" name="correctAnswer" min="0" max="3" required>
                            </div>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Add Final Exam Question</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>Bulk Upload Quiz Questions</h3>
                        <p>Upload a JSON file with multiple questions. See the example format below.</p>
                        <form id="bulkQuizUploadForm">
                            <div class="form-group">
                                <label for="bulkQuizFile">Quiz JSON File</label>
                                <input type="file" id="bulkQuizFile" name="bulkQuizFile" accept=".json" required class="file-input">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-file-upload"></i> Upload Questions
                            </button>
                        </form>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">Example format: An array of question objects. Each object needs subject, grade, unit, question, options (array), and answer (0-indexed).</p>
                        <a href="#" onclick="showJsonExample(event)">Show Example JSON</a>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="admin-section" style="display: none;">
                <h2>Reports & Analytics</h2>
                <div class="grid-2-col">
                    <div class="card">
                        <h3>User Statistics</h3>
                        <div id="userStats">
                            <!-- User statistics will be loaded here -->
                        </div>
                    </div>
                    <div class="card">
                        <h3>Payment Statistics</h3>
                        <div id="paymentStats">
                            <!-- Payment statistics will be loaded here -->
                        </div>
                    </div>
                    <div class="card">
                        <h3>Learning Progress</h3>
                        <div id="learningStats">
                            <!-- Learning statistics will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="admin-section" style="display: none;">
                <h2>Platform Settings</h2>
                <div class="card">
                    <div class="setting-item">
                        <div>
                            <h3>Enable Advanced Plan</h3>
                            <p class="setting-description">Make the "Advanced Plan" visible to the public on the homepage.</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="advancedPlanToggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="script.js"></script>
    <script>
        const subjectsList = [
            { id: 'physics', name: 'Physics' },
            { id: 'chemistry', name: 'Chemistry' },
            { id: 'biology', name: 'Biology' },
            { id: 'mathematics', name: 'Mathematics' },
            { id: 'english', name: 'English' },
            { id: 'history', name: 'History' },
            { id: 'geography', name: 'Geography' },
            { id: 'economics', name: 'Economics' },
            { id: 'english_advanced', name: 'Advanced English' }
        ];

        function populateSubjectDropdowns() {
            const subjectSelects = [document.getElementById('subject'), document.getElementById('quizSubject')];
            subjectSelects.forEach(select => {
                if (!select) return;
                select.innerHTML = '<option value="">Select Subject</option>' + subjectsList.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            });
        }

        function showSection(e, sectionName) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').style.display = 'block';
            
            // Add active class to clicked button
            if (e && e.currentTarget) {
                e.currentTarget.classList.add('active');
            }
            
            // Load section data
            loadSectionData(sectionName);
        }

        function loadSectionData(sectionName) {
            switch(sectionName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'users':
                    loadUsersData();
                    break;
                case 'payments':
                    loadPaymentsData();
                    break;
                case 'reports':
                    loadReportsData();
                    break;
                case 'settings':
                    loadSettingsData();
                    break;
            }
        }

        async function loadDashboardData() {
            // Fetch users and payments from backend
            const usersRes = await apiGet('/api/admin/users');
            const paymentsRes = await apiGet('/api/admin/payments');
            const usersJson = await usersRes.json();
            const paymentsJson = await paymentsRes.json();
            const users = usersJson.users || [];
            const payments = paymentsJson.payments || [];

            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeUsers').textContent = users.filter(u => u.verified).length;
            document.getElementById('pendingPayments').textContent = payments.filter(p => p.status === 'pending').length;
            const totalRevenue = payments.filter(p => p.status === 'verified').reduce((sum, p) => sum + (parseInt((p.amount || '0').replace(/[^\d]/g, '')) || 0), 0);
            document.getElementById('totalRevenue').textContent = totalRevenue + ' ETB';

            const recentUsers = document.getElementById('recentUsers');
            recentUsers.innerHTML = users.slice(-5).map(u => `
                <div class="recent-item">
                    <div class="recent-item-content">
                        <div>
                            <strong>${u.fullName}</strong>
                            <p class="recent-item-subtext">${u.email}</p>
                        </div>
                        <span class="recent-item-status ${u.verified ? 'verified' : 'pending'}">${u.verified ? 'Verified' : 'Pending'}</span>
                    </div>
                </div>
            `).join('') || '<p style="text-align: center; color: #666;">No users found</p>';

            const recentPayments = document.getElementById('recentPayments');
            recentPayments.innerHTML = payments.slice(-5).map(p => `
                <div class="recent-item">
                    <div class="recent-item-content">
                        <div>
                            <strong>${p.plan} Plan</strong>
                            <p class="recent-item-subtext">${p.paymentMethod}</p>
                        </div>
                        <div class="recent-item-details">
                            <div class="recent-item-amount">${p.amount} ETB</div>
                            <span class="recent-item-status ${p.status}">${p.status}</span>
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="text-align: center; color: #666;">No payments found</p>';
        }

        async function loadUsersData(page = 1) {
            const usersTable = document.getElementById('usersTable');
            const res = await apiGet(`/api/admin/users?page=${page}`);
            const data = await res.json();
            const users = data.users || [];
            usersTable.innerHTML = ''; // Clear previous data
            if (users.length) {
                usersTable.innerHTML = users.map(u => `
                    <tr>
                        <td data-label="Name">${u.fullName}</td>
                        <td data-label="Email">${u.email}</td>
                        <td data-label="School">${u.schoolName || 'N/A'}</td>
                        <td data-label="Status"><span class="unit-status ${u.paymentStatus === 'approved' ? 'completed' : u.paymentStatus === 'pending' ? 'in-progress' : 'not-started'}">${u.paymentStatus || 'none'}</span></td>
                        <td data-label="Registered">${new Date(u.createdAt || Date.now()).toLocaleDateString()}</td>
                        <td data-label="Actions">
                            <button class="btn btn-outline" onclick="verifyUser('${u._id || u.id}')" ${u.verified ? 'disabled' : ''}>
                                <i class="fas fa-check"></i> Verify
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                usersTable.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No users found</td></tr>';
            }
            renderPagination('usersPagination', data.page, data.pages, 'loadUsersData');
        }

        async function loadPaymentsData(page = 1) {
            const paymentsTable = document.getElementById('paymentsTable');
            const res = await apiGet(`/api/admin/payments?page=${page}`);
            const data = await res.json();
            const payments = data.payments || [];
            paymentsTable.innerHTML = ''; // Clear previous data
            if (payments.length) {
                paymentsTable.innerHTML = payments.map(p => `
                    <tr>
                        <td data-label="Account Name">${p.accountName || 'N/A'}</td>
                        <td data-label="Plan">${p.plan}</td>
                        <td data-label="Amount">${p.amount} ETB</td>
                        <td data-label="Method">${p.paymentMethod}</td>
                        <td data-label="Status"><span class="unit-status ${p.status === 'pending' ? 'in-progress' : p.status === 'rejected' ? 'not-started' : 'completed'}">${p.status}</span></td>
                        <td data-label="Date">${new Date(p.paymentDate).toLocaleDateString()}</td>
                        <td data-label="Account Number">${p.accountNumber || 'N/A'}</td>
                        <td data-label="Transaction ID">${p.transactionId || 'N/A'}</td>
                        <td data-label="Actions">
                            <button class="btn btn-primary" onclick="verifyPayment('${p._id || p.id}')" ${p.status !== 'pending' ? 'disabled' : ''}>
                                <i class="fas fa-check"></i> Verify
                            </button>
                            <button class="btn btn-danger" onclick="rejectPayment('${p._id || p.id}')" ${p.status !== 'pending' ? 'disabled' : ''}>
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                paymentsTable.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No payments found</td></tr>';
            }
            renderPagination('paymentsPagination', data.page, data.pages, 'loadPaymentsData');
        }

        function renderPagination(containerId, currentPage, totalPages, loadFunction) {
            const container = document.getElementById(containerId);
            if (!container || totalPages <= 1) {
                if (container) container.innerHTML = '';
                return;
            }
            let paginationHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <button 
                        class="pagination-btn ${i === currentPage ? 'active' : ''}" 
                        onclick="${loadFunction}(${i})">
                        ${i}
                    </button>
                `;
            }
            container.innerHTML = paginationHTML;
        }

        async function loadSettingsData() {
            try {
                const res = await apiGet('/api/settings/public');
                const data = await res.json();
                if (data.ok && data.settings) {
                    const toggle = document.getElementById('advancedPlanToggle');
                    toggle.checked = data.settings.advancedPlanEnabled;
                }
            } catch (e) {
                console.error('Failed to load settings', e);
                alert('Could not load platform settings.');
            }
        }

        async function handleApiAction(confirmMessage, url, successMessage, failureMessage, successCallback) {
            if (confirm(confirmMessage)) {
                try {
                    const res = await apiPost(url, {});
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || 'API request failed');
                    }
                    alert(successMessage);
                    if (successCallback) successCallback();
                } catch (err) {
                    console.error(`${failureMessage} error:`, err);
                    alert(`${failureMessage} failed: ` + err.message);
                }
            }
        }

        function verifyUser(userId) {
            handleApiAction('Are you sure you want to verify this user?', `/api/admin/users/${userId}/verify`, 'User verified successfully!', 'Verify user', loadUsersData);
        }

        function verifyPayment(paymentId) {
            handleApiAction('Are you sure you want to verify this payment?', `/api/admin/payments/${paymentId}/verify`, 'Payment verified successfully!', 'Verify payment', loadPaymentsData);
        }

        function rejectPayment(paymentId) {
            handleApiAction('Are you sure you want to reject this payment?', `/api/admin/payments/${paymentId}/reject`, 'Payment rejected successfully!', 'Reject payment', loadPaymentsData);
        }

        function refreshUsers() {
            loadUsersData();
            alert('Users data refreshed!');
        }

        function refreshPayments() {
            loadPaymentsData();
            alert('Payments data refreshed!');
        }

        // Add logic to adapt content forms for Advanced English

        document.getElementById('quizSubject').addEventListener('change', function() {
            const isAdvanced = this.value === 'english_advanced';
            const gradeGroup = document.getElementById('quizGrade').parentElement; // Get the form-group
            const unitGroup = document.getElementById('quizUnit').parentElement; // Get the form-group
            const gradeSelect = document.getElementById('quizGrade');
            const unitInput = document.getElementById('quizUnit');
            
            if (isAdvanced) {
                gradeGroup.style.display = 'none';
                unitGroup.style.display = 'none';
                gradeSelect.required = false;
                unitInput.required = false;
            } else {
                gradeGroup.style.display = 'block';
                unitGroup.style.display = 'block';
                gradeSelect.required = true;
                unitInput.required = true;
            }
            document.getElementById('quizUnitLabel').textContent = isAdvanced ? 'Section' : 'Unit';
        });

        // Settings toggle handler
        document.getElementById('advancedPlanToggle').addEventListener('change', async function(e) {
            const isEnabled = e.target.checked;
            try {
                const res = await apiPost('/api/admin/settings', { advancedPlanEnabled: isEnabled });
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || 'Failed to update setting');
                }
                alert('Setting updated successfully!');
            } catch (err) {
                alert('Failed to update setting: ' + err.message);
            }
        });

        // Reports Section Loader
        async function loadReportsData() {
            const usersRes = await apiGet('/api/admin/users');
            const paymentsRes = await apiGet('/api/admin/payments');
            const usersJson = await usersRes.json();
            const paymentsJson = await paymentsRes.json();
            const users = usersJson.users || [];
            const payments = paymentsJson.payments || [];

            // User Stats
            const userStats = document.getElementById('userStats');
            userStats.innerHTML = `
                <div class="report-stat-item"><strong>Total Users:</strong> <span>${users.length}</span></div>
                <div class="report-stat-item"><strong>Verified Users:</strong> <span>${users.filter(u => u.verified).length}</span></div>
            `;

            // Payment Stats
            const paymentStats = document.getElementById('paymentStats');
            const totalRevenue = payments.filter(p => p.status === 'verified').reduce((sum, p) => sum + (parseInt((p.amount || '0').replace(/[^\d]/g, '')) || 0), 0);
            paymentStats.innerHTML = `
                <div class="report-stat-item"><strong>Total Payments:</strong> <span>${payments.length}</span></div>
                <div class="report-stat-item"><strong>Pending Payments:</strong> <span>${payments.filter(p => p.status === 'pending').length}</span></div>
                <div class="report-stat-item"><strong>Total Revenue:</strong> <span>${totalRevenue} ETB</span></div>
            `;

            // Learning Stats (Placeholder)
            const learningStats = document.getElementById('learningStats');
            learningStats.innerHTML = `<p class="text-center" style="color: #666;">Learning progress analytics are under development.</p>`;
        }

        // Content upload form
        document.getElementById('contentUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            // Manually update the 'content' field in FormData from the CKEditor instance.
            // This is necessary because CKEditor doesn't automatically update the underlying textarea.
            formData.set('content', CKEDITOR.instances.content.getData());

            // If "Advanced English" is selected, it doesn't have grades/units in the UI.
            // We need to add default values here so the backend validation passes.
            if (formData.get('subject') === 'english_advanced') {
                formData.set('grade', '0'); // Use 0 as a convention for non-graded content
                formData.set('unit', '1');  // Use 1 as a default section/unit
            }

            try {
                // When sending FormData with fetch, we must not set the 'Content-Type' header.
                // The browser does this automatically and includes the necessary boundary.
                // We create a new Headers object to add our auth token without interfering.
                const headers = new Headers();
                headers.append('Authorization', 'Bearer ' + getAuthToken());

                const res = await fetch('/api/admin/content', {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Failed to upload content');
                }
                alert('Content uploaded successfully!');
                this.reset();
                CKEDITOR.instances.content.setData(''); // Clear the editor after successful upload
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        // Add logic to hide Grade/Unit for "Advanced English"
        document.getElementById('subject').addEventListener('change', function() {
            const isAdvanced = this.value === 'english_advanced';
            const gradeGroup = document.getElementById('gradeGroup');
            const unitGroup = document.getElementById('unitGroup');
            const gradeInput = document.getElementById('grade');
            const unitInput = document.getElementById('unit');

            if (isAdvanced) {
                gradeGroup.style.display = 'none';
                unitGroup.style.display = 'none';
                gradeInput.required = false;
                unitInput.required = false;
            } else {
                gradeGroup.style.display = 'block';
                unitGroup.style.display = 'block';
                gradeInput.required = true;
                unitInput.required = true;
            }
        });
        // Quiz upload form
        document.getElementById('quizUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            data.options = data.options.split('\n').filter(o => o.trim() !== '');
            data.answer = parseInt(data.correctAnswer, 10); // Backend expects 'answer'

            // Rename fields to match backend schema
            data.grade = data.quizGrade;
            data.unit = data.quizUnit;
            data.subject = data.quizSubject;

            // If "Advanced English" is selected, add default values for grade/unit.
            if (data.subject === 'english_advanced') {
                data.grade = 0;
                data.unit = 1;
            }

            apiPost('/api/admin/quiz', data)
                .then(async res => {
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || 'Failed to add question');
                    }
                    alert('Quiz question added successfully!');
                    this.reset();
                }).catch(err => alert('Error: ' + err.message));
        });

        // Final Exam upload form
        document.getElementById('finalExamUploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            data.options = data.options.split('\n').filter(o => o.trim() !== '');
            data.correctAnswer = parseInt(data.correctAnswer, 10);

            apiPost('/api/admin/quiz', { ...data, subject: 'final', grade: 0, unit: 1 })
                .then(async res => {
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || 'Failed to add final exam question');
                    }
                    alert('Final exam question added successfully!');
                    this.reset();
                })
                .catch(err => {
                    alert('Error: ' + err.message);
                });
        });

        // Bulk Quiz upload form
        document.getElementById('bulkQuizUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('bulkQuizFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a JSON file to upload.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const questions = JSON.parse(event.target.result);
                    if (!Array.isArray(questions) || questions.length === 0) {
                        throw new Error('JSON file must contain an array of at least one question object.');
                    }

                    // Post the array of questions to the new bulk endpoint
                    apiPost('/api/admin/quiz/bulk', questions)
                        .then(async res => {
                            const data = await res.json();
                            if (!res.ok) {
                                throw new Error(data.error || 'Failed to upload questions.');
                            }
                            alert(data.message || 'Questions uploaded successfully!');
                            fileInput.value = ''; // Reset file input
                        })
                        .catch(err => alert('Upload Error: ' + err.message));

                } catch (err) {
                    alert('Error parsing JSON file: ' + err.message);
                }
            };
            reader.onerror = () => alert('Error reading file.');
            reader.readAsText(file);
        });

        function logout() {
            localStorage.removeItem('isAdminLoggedIn');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('authToken'); // Also remove the token
            window.location.href = 'index.html';
        }

        // Mobile menu handled globally in script.js

        // Check if admin is logged in (token + admin flag)
        if (localStorage.getItem('isAdminLoggedIn') !== 'true' || !getAuthToken()) {
            window.location.href = 'login.html';
        }

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();

            populateSubjectDropdowns();
            // Initialize CKEditor on the content textarea
            CKEDITOR.replace('content');
        });

        function showJsonExample(event) {
            event.preventDefault();
            const example = `[
  {
    "subject": "physics",
    "grade": 9,
    "unit": 1,
    "question": "What is the SI unit of force?",
    "options": ["Joule", "Watt", "Newton", "Pascal"],
    "answer": 2,
    "explanation": "The SI unit of force is the Newton (N)."
  },
  {
    "subject": "chemistry",
    "grade": 10,
    "unit": 2,
    "question": "What is the chemical formula for water?",
    "options": ["CO2", "H2O", "O2", "NaCl"],
    "answer": 1,
    "explanation": "The chemical formula for water is H2O, representing two hydrogen atoms and one oxygen atom."
  }
]`;
            alert("Your JSON file content should look like this:\n\n" + example);
        }
    </script>
</body>
</html>
