<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Luminar School</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2><a href="index.html" style="color: white; text-decoration: none;">Luminar School</a></h2>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">Home</a>
                </li>
                <li class="nav-item">
                    <a href="register.html" class="nav-link register-btn">Register</a>
                </li>
            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Login Form -->
    <div class="form-container">
        <div class="form-header">
            <h2>Welcome Back</h2>
            <p>Sign in to continue your learning journey</p>
        </div>

        <form id="loginForm">
            <div class="form-group">
                <label for="email">Email Address *</label>
                <input type="email" id="email" name="email" required>
                <div class="error" id="emailError"></div>
            </div>

            <div class="form-group">
                <label for="password">Password *</label>
                <input type="password" id="password" name="password" required>
                <div class="error" id="passwordError"></div>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="rememberMe" name="rememberMe">
                    Remember me
                </label>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                <i class="fas fa-sign-in-alt"></i> Sign In
            </button>
        </form>

        <div class="form-footer">
            <p><a href="forgot-password.html" style="color: #667eea;">Forgot your password?</a></p>
            <p>Don't have an account? <a href="register.html">Register here</a></p>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('adminModal')">&times;</span>
            <h2>Admin Access</h2>
            <p>Enter admin credentials to access the admin panel:</p>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminEmail">Admin Email</label>
                    <input type="email" id="adminEmail" name="adminEmail" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Admin Password</label>
                    <input type="password" id="adminPassword" name="adminPassword" required>
                </div>
                <div style="text-align: center; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">Access Admin Panel</button>
                    <button type="button" class="btn btn-outline" onclick="closeModal('adminModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Login form validation
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Clear previous errors
            clearErrors();
            
            // Get form data
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            // Validate form
            let isValid = true;
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email || !emailRegex.test(email)) {
                showError('emailError', 'Please enter a valid email address');
                isValid = false;
            }
            
            // Password validation
            if (!password || password.length < 6) {
                showError('passwordError', 'Password must be at least 6 characters long');
                isValid = false;
            }
            
            if (isValid) {
                // Clear stale user data from cache before logging in.
                // This forces the next page to fetch fresh data from the server.
                localStorage.removeItem('currentUser');

                // Call backend login
                apiPost('/api/login', { email, password })
                  .then(async (res) => {
                    const data = await res.json();
                    // End any active trial session upon successful login
                    endTrial();

                    if (!res.ok) throw new Error(data.error || 'Login failed');
                    if (data && data.token) setAuthToken(data.token);

                    // Use localStorage for "Remember Me" functionality
                    const storage = rememberMe ? localStorage : sessionStorage;
                    
                    // Clear any previous session data from both storages
                    clearSessionData();
                    
                    // Check if user is admin
                    if (data.user.role === 'admin') {
                        localStorage.setItem('isAdminLoggedIn', 'true');
                        console.log('Admin user, redirecting to admin panel');
                        window.location.href = 'admin.html';
                    } else {
                        // Regular user - check verification
                        if (data.user.paymentStatus !== 'approved') {
                            let alertMessage = '';
                            switch (data.user.paymentStatus) {
                                case 'pending':
                                    alertMessage = 'Your account is waiting for admin approval. Please check back later.';
                                    break;
                                case 'rejected':
                                    alertMessage = 'Your payment was rejected. Please go to the payment page to try again or contact support.';
                                    break;
                                default: // 'none'
                                    alertMessage = 'Your enrollment is not yet complete. Please proceed to the payment page to activate your account.';
                                    break;
                            }
                            alert(alertMessage);
                            return;
                        }

                        // If approved, proceed to dashboard
                        // Only set login status and user data upon successful, approved login
                        storage.setItem('isLoggedIn', 'true');
                        storage.setItem('currentUser', JSON.stringify(data.user));
                        storage.setItem('authToken', data.token); // Use 'authToken' to be consistent
                        window.location.href = 'dashboard.html';
                    }
                  })
                  .catch((err) => {
                    showError('passwordError', err.message);
                  });
            }
        });

        function clearSessionData() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('authToken');
            sessionStorage.clear();
        }
        
        // Admin login form
        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const adminEmail = document.getElementById('adminEmail').value;
            const adminPassword = document.getElementById('adminPassword').value;
            
            apiPost('/api/login', { email: adminEmail, password: adminPassword })
              .then(async (res) => {
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Login failed');
                if (data && data.token) setAuthToken(data.token);
                if (data.user && data.user.role !== 'admin') throw new Error('Not an admin');
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('isAdminLoggedIn', 'true');
                localStorage.setItem('currentUser', JSON.stringify(data.user));
                closeModal('adminModal');
                window.location.href = 'admin.html';
              })
              .catch(() => alert('Invalid admin credentials'));
        });
        
        function clearErrors() {
            const errorElements = document.querySelectorAll('.error');
            errorElements.forEach(element => {
                element.textContent = '';
            });
        }
        
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
            }
        }
        
        // Mobile menu handled globally in script.js
        
        // Remove any automatic redirect logic from page load
        // Only handle redirect after login form submission
    </script>
</body>
</html>
